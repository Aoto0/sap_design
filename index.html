<!--
Copyright © 2025 Parallax Project Management LTD. All Rights Reserved.
This software/code may not be copied, distributed, or used without explicit written permission.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Saps Design App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f9fa; margin: 0; }
    .container { max-width: 400px; margin: 0 auto; background: #fff; min-height: 100vh; box-shadow: 0 4px 24px #0002; }
    header { background: #003366; color: #fff; padding: 18px 0; text-align: center; font-size: 1.35em; }
    .content { padding: 24px; }
    .input-group { margin-bottom: 18px; }
    label { display: block; margin-bottom: 6px; color: #003366; font-weight: bold; }
    input[type="text"], input[type="number"], input[type="password"], select { width: 100%; padding: 9px; border: 1px solid #bbb; border-radius: 6px; }
    input[type="number"] { max-width: 120px; }
    button { background: #003366; color: #fff; border: none; padding: 11px 0; width: 100%; border-radius: 6px; font-size: 1em; margin-top: 10px; cursor: pointer; }
    button:active { background: #005599; }
    .top-btn { background: #005599; color: #fff; border: none; padding: 7px 12px; border-radius: 5px; font-size: 0.95em; margin-left: 6px; cursor: pointer; }
    .project-list { margin: 0; padding: 0; list-style: none; }
    .project-list li { background: #f1f3f7; margin-bottom: 10px; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
    .section-title { color: #003366; margin: 22px 0 14px 0; font-weight: bold; }
    .summary { background: #e7f0fa; padding: 13px; border-radius: 7px; font-size: 1em; margin: 20px 0; }
    .hidden { display: none; }
    .upload-box { background: #f5fafc; border: 1px dashed #0067b8; padding: 12px 8px; border-radius: 7px; margin-bottom: 10px; }
    .uploaded-file { font-size: 0.95em; color: #003366; margin: 5px 0 0 0; }
    .uval-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px;}
    .uval-row label {margin:0; font-weight:normal;}
    .uval-row input[type="number"] {max-width:70px;}
    .uval-row span {font-size:0.93em;color:#555;}
    .windows-list {margin-bottom:10px;}
    .window-row {display:flex;align-items:center;gap:5px;margin-bottom:4px;}
    .window-row select, .window-row input {font-size:0.95em;padding:5px;}
    .window-row button {background:#d33;color:#fff;padding:2px 7px;margin-left:3px;font-size:1em;}
    .window-size-input {width:60px; margin-left:2px;}
    .solar-pv-input {margin-top: 10px;}
    .solar-pv-input label {margin-bottom: 2px;}
    .labour-table, .materials-table, .total-table {margin:12px 0 0 0;font-size:0.98em;width:100%;border-collapse:collapse;}
    .labour-table th, .labour-table td,
    .materials-table th, .materials-table td,
    .total-table th, .total-table td
    {padding:4px 6px;border-bottom:1px solid #e6e6e6;text-align:left;}
    .labour-table th, .materials-table th, .total-table th {background:#f5fafc;}
    .labour-total-row td, .materials-total-row td, .total-table td {font-weight:bold;}
    .profit-row td {color:#007a33;}
    @media (max-width: 480px) {
      .container { max-width: 100vw; min-height: 100vh; border-radius: 0; box-shadow: none; }
      .content { padding: 16px; }
      .labour-table, .materials-table, .total-table {font-size:0.93em;}
    }
    .upload-multifiles-note {font-size:0.95em; color:#005599;}
  </style>
</head>
<body>
  <div class="container">
    <header>Saps Design App</header>
    <div class="content">

      <!-- Login Screen -->
      <form id="login-screen">
        <div class="section-title">Login</div>
        <div class="input-group">
          <label for="email">Email</label>
          <input type="text" id="email" autocomplete="username">
        </div>
        <div class="input-group">
          <label for="password">Password</label>
          <input type="password" id="password" autocomplete="current-password">
        </div>
        <button type="submit">Login</button>
      </form>

      <!-- Project List -->
      <div id="projects-screen" class="hidden">
        <div class="section-title">My Projects</div>
        <ul class="project-list" id="project-list"></ul>
        <button onclick="showAddProject()">+ Add New Project</button>
        <!-- Architectural Plans Builder Button (added feature) -->
        <div class="input-group" style="margin-top:24px;">
          <button id="architect-builder-btn" style="width:100%;background:#005599;color:#fff;font-size:1.15em;padding:12px;border-radius:8px;border:none;cursor:pointer;">
            Architectural Plans Builder
          </button>
        </div>
        <button class="top-btn" style="background:#aaa;" onclick="logout()">Log Out</button>
      </div>

      <!-- Add Project -->
      <form id="add-project-screen" class="hidden">
        <div class="section-title">New Project</div>
        <div class="input-group">
          <label for="pname">Project Name</label>
          <input type="text" id="pname" required>
        </div>
        <div class="input-group">
          <label for="paddr1">Address Line 1</label>
          <input type="text" id="paddr1" required>
        </div>
        <div class="input-group">
          <label for="paddr2">Address Line 2</label>
          <input type="text" id="paddr2">
        </div>
        <div class="input-group">
          <label for="paddr3">Town/City</label>
          <input type="text" id="paddr3" required>
        </div>
        <div class="input-group">
          <label for="ppostcode">Post Code</label>
          <input type="text" id="ppostcode" required>
        </div>
        <div class="upload-box">
          <label for="plans-upload-civils"><b>Upload Ground Works/Civils Plans:</b></label>
          <input type="file" id="plans-upload-civils" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
          <div id="uploaded-files-list-civils"></div>
        </div>
        <div class="upload-box">
          <label for="plans-upload-ground"><b>Upload Ground Floor Plans:</b></label>
          <input type="file" id="plans-upload-ground" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
          <div id="uploaded-files-list-ground"></div>
        </div>
        <div class="upload-box">
          <label for="plans-upload-first"><b>Upload First Floor Plans:</b></label>
          <input type="file" id="plans-upload-first" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
          <div id="uploaded-files-list-first"></div>
        </div>
        <div class="upload-box">
          <label for="plans-upload-spec"><b>Upload Project Specification:</b></label>
          <input type="file" id="plans-upload-spec" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
          <div id="uploaded-files-list-spec"></div>
        </div>
        <div class="upload-multifiles-note" id="plans-message"></div>
        <div id="plans-note" style="display:none; color:#005599; font-size:0.97em; margin-bottom:10px;">
          <b>Fields will be auto-filled from uploaded plans/spec.</b>
        </div>
        <div class="input-group">
          <label for="ptype">Project Type</label>
          <select id="ptype" onchange="showStoreyOptions()">
            <option value="new-build-house">New Build House</option>
            <option value="extension">Extension</option>
            <option value="bungalow">Bungalow</option>
            <option value="3-storey-house">3 Storey House</option>
            <option value="alteration">Alteration</option>
          </select>
        </div>
        <div class="input-group" id="storeys-group" style="display:none;">
          <label for="storeys">Number of Storeys</label>
          <select id="storeys">
            <option value="1">1 (Bungalow/Extension)</option>
            <option value="2" selected>2 (Standard House)</option>
            <option value="3">3</option>
          </select>
        </div>
        <button type="submit">Create Project</button>
        <button class="top-btn" type="button" onclick="showProjects()">Back</button>
      </form>

      <!-- Project Details + SAP Input -->
      <form id="project-details-screen" class="hidden" autocomplete="off">
        <div class="section-title" id="project-title"></div>
        <div id="plans-note-details" style="display:none; color:#005599; font-size:0.97em; margin-bottom:10px;">
          <b>Fields auto-filled from uploaded plans/spec.</b>
        </div>
        <div class="input-group">
          <label for="ceiling-height">Ceiling Height (m)</label>
          <input type="number" id="ceiling-height" min="2" max="5" step="0.01" value="2.4">
        </div>
        <div class="input-group">
          <label for="floor-type">Floor Build-up</label>
          <select id="floor-type" onchange="updateUValue('floor')"></select>
          <div class="insulation-thick" id="floor-insul-group"></div>
          <div class="uval-row">
            <label>U-Value</label>
            <input type="number" id="floor-uval" step="0.01" min="0.05" max="1" onchange="manualUValue('floor')">
            <span id="floor-uval-ref"></span>
          </div>
          <label for="floor-area">Floor Area (m²)</label>
          <input type="number" id="floor-area" min="1" value="60">
        </div>
        <div class="input-group">
          <label for="wall-type">Wall Build-up</label>
          <select id="wall-type" onchange="updateUValue('wall')"></select>
          <div class="insulation-thick" id="wall-insul-group"></div>
          <div class="uval-row">
            <label>U-Value</label>
            <input type="number" id="wall-uval" step="0.01" min="0.05" max="1" onchange="manualUValue('wall')">
            <span id="wall-uval-ref"></span>
          </div>
          <label for="wall-area">Wall Area (m²)</label>
          <input type="number" id="wall-area" min="1" value="120">
        </div>
        <div class="input-group">
          <label for="roof-type">Roof Build-up</label>
          <select id="roof-type" onchange="updateUValue('roof')"></select>
          <div class="insulation-thick" id="roof-insul-group"></div>
          <div class="uval-row">
            <label>U-Value</label>
            <input type="number" id="roof-uval" step="0.01" min="0.05" max="1" onchange="manualUValue('roof')">
            <span id="roof-uval-ref"></span>
          </div>
          <label for="roof-area">Roof Area (m²)</label>
          <input type="number" id="roof-area" min="1" value="80">
        </div>
        <div class="input-group">
          <label for="doors">Front Door (for thermal bridging)</label>
          <select id="doors">
            <option>Standard uPVC</option>
            <option>Composite</option>
            <option>Timber</option>
          </select>
        </div>
        <div class="input-group">
          <label for="door-orient">Front Door Orientation</label>
          <select id="door-orient">
            <option>North</option>
            <option>South</option>
            <option>East</option>
            <option>West</option>
          </select>
        </div>
        <div class="input-group">
          <label>Number of Rooms</label>
          <input type="number" id="num-rooms" min="1" value="5">
        </div>
        <div class="input-group">
          <label>Windows</label>
          <div class="windows-list" id="windows-list"></div>
          <button type="button" style="background:#007a33;" onclick="addWindow()">+ Add Window</button>
        </div>
        <div class="input-group solar-pv-input" id="solar-pv-group" style="display:none;">
          <label for="solar-pv-size">Solar PV System Size (kWp)</label>
          <input type="number" id="solar-pv-size" min="0" step="0.01" value="0">
          <label for="solar-pv-kwh" style="margin-top:6px;">Estimated Annual Output (kWh)</label>
          <input type="number" id="solar-pv-kwh" min="0" step="1" value="0">
        </div>
        <div class="input-group">
          <label for="renewables">Renewable Energy</label>
          <select id="renewables" onchange="showSolarPVInput()">
            <option>None</option>
            <option>Solar PV</option>
            <option>Solar Thermal</option>
            <option>Heat Pump</option>
          </select>
        </div>
        <div class="input-group">
          <label for="heating">Heating Source</label>
          <select id="heating">
            <option>Gas Boiler</option>
            <option>ASHP (Air Source Heat Pump)</option>
            <option>GSHP (Ground Source Heat Pump)</option>
            <option>Electric</option>
          </select>
        </div>
        <div class="input-group">
          <label for="heating-kw">Heating System Output (kW)</label>
          <input type="number" id="heating-kw" min="0" step="0.1" placeholder="e.g. 18">
        </div>
        <button type="button" onclick="generateReport()">Generate Reports</button>
        <button class="top-btn" type="button" onclick="showProjects()">Back</button>
      </form>

      <!-- Reports Screen -->
      <div id="reports-screen" class="hidden">
        <div class="section-title">Reports</div>
        <div class="summary" id="report-summary"></div>
        <button onclick="showProjects()">Back to Projects</button>
        <div style="margin-top: 18px;">
          <h3 style="color:#003366;">Materials List Generator</h3>
          <p style="margin-bottom:8px;">Generate a basic materials list for quoting from a building supplier:</p>
          <button onclick="generateMaterialsList(true)" type="button" style="background:#007a33;">Generate Materials List</button>
          <button onclick="emailMaterialsQuote()" type="button" style="background:#005599;">Get Materials Quote</button>
          <div id="materials-list-output" style="margin-top:12px; background:#e7f0fa; border-radius:6px; padding:10px; font-size:0.97em; display:none;"></div>
        </div>
      </div>

      <!-- Architectural Plans Builder Page (NEW FEATURE) -->
      <div id="architect-builder-screen" class="hidden">
        <div class="section-title">Architectural Plans Builder</div>
        <form id="architect-plans-form" autocomplete="off">
          <div class="input-group">
            <label for="house-width">House Width (m)</label>
            <input type="number" id="house-width" min="2" step="0.1" required>
          </div>
          <div class="input-group">
            <label for="house-length">House Length (m)</label>
            <input type="number" id="house-length" min="2" step="0.1" required>
          </div>
          <div class="input-group">
            <label for="house-height">House Height (m)</label>
            <input type="number" id="house-height" min="2" step="0.1" required>
          </div>
          <div class="input-group">
            <label for="downstairs-rooms">Select Downstairs Rooms</label>
            <select id="downstairs-rooms" multiple>
              <option value="Kitchen">Kitchen</option>
              <option value="Living Room">Living Room</option>
              <option value="Hallway">Hallway</option>
              <option value="Bathroom">Bathroom</option>
              <option value="Utility">Utility</option>
              <option value="Dining Room">Dining Room</option>
              <option value="Office">Office</option>
            </select>
            <small>Select one or more rooms (CTRL+Click for multi-select)</small>
          </div>
          <div class="input-group">
            <label for="upstairs-rooms">Select Upstairs Rooms</label>
            <select id="upstairs-rooms" multiple>
              <option value="Bedroom">Bedroom</option>
              <option value="Bathroom">Bathroom</option>
              <option value="Ensuite">Ensuite</option>
              <option value="Landing">Landing</option>
              <option value="Storage">Storage</option>
            </select>
            <small>Select one or more rooms (CTRL+Click for multi-select)</small>
          </div>
          <button type="submit" style="background:#007a33;">Build Plans</button>
          <button type="button" onclick="showScreen('projects-screen')" style="background:#003366;">Back</button>
        </form>
        <div id="architect-plans-output" style="margin-top:24px;"></div>
        <div id="architect-2d-plan" style="margin-top:24px;"></div>
      </div>
      <!-- END NEW FEATURE -->

    </div>
  </div>
<script>
// Copyright © 2025 Parallax Project Management LTD. All Rights Reserved.

const UVALS = {
  floor: [
    {name: "Solid Concrete + 100mm Insulation", u: 0.16, insulation: "100mm"},
    {name: "Solid Concrete + 150mm Insulation", u: 0.13, insulation: "150mm"},
    {name: "Suspended Timber + 200mm Insulation", u: 0.12, insulation: "200mm"},
    {name: "Beam & Block + 100mm Insulation", u: 0.18, insulation: "100mm"},
    {name: "Beam & Block + 150mm Insulation", u: 0.16, insulation: "150mm"}
  ],
  wall: [
    {name: "Cavity Wall (Brick + Block + 100mm Insulation)", u: 0.18, insulation: "100mm"},
    {name: "Cavity Wall (Brick + Block + 150mm Insulation)", u: 0.15, insulation: "150mm"},
    {name: "Timber Frame (with 150mm Insulation)", u: 0.16, insulation: "150mm"},
    {name: "SIP Panel + 200mm Insulation", u: 0.13, insulation: "200mm"}
  ],
  roof: [
    {name: "Pitched Roof (Insulation at Ceiling, 200mm)", u: 0.14, insulation: "200mm"},
    {name: "Pitched Roof (Insulation at Rafter, 150mm)", u: 0.16, insulation: "150mm"},
    {name: "Flat Roof (Warm Roof, 150mm)", u: 0.18, insulation: "150mm"},
    {name: "Flat Roof (Warm Roof, 100mm)", u: 0.22, insulation: "100mm"}
  ]
};
const WINDOW_TYPES = [
  { value: "Double Glazed", label: "Double Glazed (U=2.8 W/m²K)", u: 2.8 },
  { value: "Low E Double Glazed", label: "Low E Double Glazed (U=1.6 W/m²K)", u: 1.6 },
  { value: "Triple Glazed", label: "Triple Glazed (U=1.0 W/m²K)", u: 1.0 },
  { value: "Secondary Glazing", label: "Secondary Glazing (U=2.0 W/m²K)", u: 2.0 },
  { value: "Single Glazed", label: "Single Glazed (U=4.8 W/m²K)", u: 4.8 }
];
const MATERIAL_PRICES = {
  "Floor Insulation": 13, "Concrete/floor slab (ground floor)": 120, "Damp proof membrane": 4,
  "Sand (floor slab)": 3.5, "Cement (floor slab)": 6, "Wall Insulation": 14,
  "Bricks (outer leaf)": 1.1, "Concrete blocks (inner leaf)": 1.2, "Wall ties": 0.15,
  "Cavity closers": 4, "Sand (mortar)": 3.5, "Cement (mortar)": 6,
  "Timber frame kit": 45, "OSB/sheathing": 6, "External cladding/render": 25,
  "SIP panels": 60, "Panel fixings/plates": 0, "Roof Insulation": 13,
  "Roof covering (tiles/membrane)": 20, "Roof underlay/battens": 4, "Gutters": 7,
  "Fascia boards": 8, "Soffit boards": 7, 
  "Stairs": 800,
  "1st fix plumbing": 500,
  "2nd fix plumbing": 600,
  "Radiator": 150,
  "1st fix electrics": 400,
  "2nd fix electrics": 300,
  "Socket": 25,
  "LED downlight": 20,
  "EV charger": 1200,
  "Joinery": 1200,
  "Ironmongery": 300,
  "Window": 260, "Front door (with frame/threshold/locking)": 600,
  "Solar PV panels": 700, "PV inverter/mount/cabling": 0,
  "Plasterboard/internal wall finish": 4,
  "Ceiling board": 4,
  "Skirting & architrave": 6,
  "Wall paint": 25,
  "Ceiling paint": 20,
  "Plaster (skim)": 5
};

function getMaterialPrice(item, qty) {
  for (let k in MATERIAL_PRICES) if (item.startsWith(k)) return MATERIAL_PRICES[k]*qty;
  if (/^Window \d+/.test(item)) return MATERIAL_PRICES["Window"] * qty;
  return 0;
}

let projects = [], currentProject = null, uvalManual = {floor: false, wall: false, roof: false}, windowsData = [], uploadedPlans = {
  civils: null,
  ground: null,
  first: null,
  spec: null
};

function showScreen(id) {
  document.querySelectorAll('.content > *').forEach(e => e.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
document.addEventListener("DOMContentLoaded", function() { showScreen('login-screen'); });

document.getElementById('login-screen').onsubmit = function(e) {
  e.preventDefault();
  showProjects();
};

function showProjects() {
  const list = document.getElementById('project-list');
  list.innerHTML = '';
  projects.forEach((p, idx) => {
    let addressFull = [p.address1, p.address2, p.address3].filter(Boolean).join(', ');
    const li = document.createElement('li');
    li.innerHTML = `<span>
    <b>${p.name}</b><br>
    <span style="font-size:0.93em">${addressFull} (${p.postcode})</span>
    </span>
    <button class="top-btn" onclick="editProject(${idx})">Open</button>`;
    list.appendChild(li);
  });
  showScreen('projects-screen');
}
function showAddProject() {
  document.getElementById('pname').value = '';
  document.getElementById('paddr1').value = '';
  document.getElementById('paddr2').value = '';
  document.getElementById('paddr3').value = '';
  document.getElementById('ppostcode').value = '';
  document.getElementById('ptype').value = 'new-build-house';
  showStoreyOptions();
  showScreen('add-project-screen');
}
document.getElementById('add-project-screen').onsubmit = function(e) {
  e.preventDefault();
  const pname = document.getElementById('pname').value;
  const paddr1 = document.getElementById('paddr1').value;
  const paddr2 = document.getElementById('paddr2').value;
  const paddr3 = document.getElementById('paddr3').value;
  const ppostcode = document.getElementById('ppostcode').value;
  const ptype = document.getElementById('ptype').options[document.getElementById('ptype').selectedIndex].text;
  const storeys = document.getElementById('storeys').value;
  projects.push({ name: pname, address1: paddr1, address2: paddr2, address3: paddr3, postcode: ppostcode, type: ptype, storeys: storeys, plans: {...uploadedPlans} });
  uploadedPlans = { civils: null, ground: null, first: null, spec: null };
  document.getElementById('uploaded-files-list-civils').innerHTML = '';
  document.getElementById('uploaded-files-list-ground').innerHTML = '';
  document.getElementById('uploaded-files-list-first').innerHTML = '';
  document.getElementById('uploaded-files-list-spec').innerHTML = '';
  document.getElementById('plans-message').textContent = '';
  document.getElementById('plans-note').style.display = 'none';
  showProjects();
};
function logout() { showScreen('login-screen'); }
function showStoreyOptions() {
  var ptype = document.getElementById('ptype').value;
  var storeyGroup = document.getElementById('storeys-group');
  var storeys = document.getElementById('storeys');
  if (ptype === "new-build-house" || ptype === "3-storey-house" || ptype === "extension" || ptype === "bungalow") {
    storeyGroup.style.display = '';
    if (ptype === "3-storey-house") { storeys.value = "3"; }
    else if (ptype === "new-build-house") { storeys.value = "2"; }
    else if (ptype === "extension" || ptype === "bungalow") { storeys.value = "1"; }
  } else { storeyGroup.style.display = 'none'; storeys.value = "1"; }
}
function editProject(idx) {
  currentProject = idx;
  const p = projects[idx];
  let storeyText = p.storeys && p.storeys > 1 ? ` (${p.storeys} Storeys)` : (p.storeys == 1 ? ' (1 Storey)' : '');
  document.getElementById('project-title').textContent = `${p.name} – ${p.type}${storeyText}`;
  fillUValDropdowns();
  windowsData = [{wall:"Front",width:1.2,height:1.2, type:"Double Glazed"}];
  renderWindows();
  showSolarPVInput();
  if (p.plans && (p.plans.civils || p.plans.ground || p.plans.first || p.plans.spec)) { document.getElementById('plans-note-details').style.display = ''; }
  else { document.getElementById('plans-note-details').style.display = 'none'; }
  showScreen('project-details-screen');
}
function fillUValDropdowns() {
  ['floor','wall','roof'].forEach(type=>{
    let sel = document.getElementById(type+'-type');
    sel.innerHTML = '';
    UVALS[type].forEach((opt,i)=>{
      let o = document.createElement('option');
      o.value = i;
      o.textContent = opt.name;
      sel.appendChild(o);
    });
  });
  updateUValue('floor');
  updateUValue('wall');
  updateUValue('roof');
}
function updateUValue(type) {
  let sel = document.getElementById(type+'-type');
  let idx = sel.value;
  let u = UVALS[type][idx].u;
  let insul = UVALS[type][idx].insulation;
  document.getElementById(type+'-uval').value = u.toFixed(2);
  document.getElementById(type+'-uval-ref').textContent = "(default: "+u.toFixed(2)+")";
  document.getElementById(type+'-insul-group').textContent = "Insulation thickness: " + insul;
  uvalManual[type] = false;
}
function manualUValue(type) {
  uvalManual[type] = true;
  document.getElementById(type+'-uval-ref').textContent = "(manual override)";
}
function addWindow() {
  if (windowsData.length > 49) return;
  windowsData.push({wall: "Front", width: 1.2, height: 1.2, type: "Double Glazed"});
  renderWindows();
}
function removeWindow(idx) { windowsData.splice(idx, 1); renderWindows(); }
function updateWindow(idx, field, value) {
  if(field === 'width' || field === 'height') { windowsData[idx][field] = parseFloat(value) || 0; }
  else { windowsData[idx][field] = value; }
  renderWindows();
}
function renderWindows() {
  const list = document.getElementById('windows-list');
  list.innerHTML = '';
  windowsData.forEach((win, idx) => {
    let row = document.createElement('div');
    row.className = 'window-row';
    let wallSel = document.createElement('select');
    ['Front','Back','Left','Right'].forEach(loc=>{
      let o = document.createElement('option');
      o.value = loc; o.textContent = loc; if (win.wall === loc) o.selected = true;
      wallSel.appendChild(o);
    });
    wallSel.onchange = e => { updateWindow(idx, 'wall', e.target.value); };
    let widthInput = document.createElement('input'); widthInput.type = 'number'; widthInput.className = 'window-size-input';
    widthInput.value = win.width || 1.2; widthInput.min = "0"; widthInput.step = "0.01"; widthInput.title = "Width (m)";
    widthInput.oninput = e => updateWindow(idx, 'width', e.target.value);
    let heightInput = document.createElement('input'); heightInput.type = 'number'; heightInput.className = 'window-size-input';
    heightInput.value = win.height || 1.2; heightInput.min = "0"; heightInput.step = "0.01"; heightInput.title = "Height (m)";
    heightInput.oninput = e => updateWindow(idx, 'height', e.target.value);
    let typeSel = document.createElement('select');
    WINDOW_TYPES.forEach(opt => {
      let o = document.createElement('option');
      o.value = opt.value; o.textContent = opt.label; if (win.type === opt.value) o.selected = true;
      typeSel.appendChild(o);
    });
    typeSel.onchange = e => { updateWindow(idx, 'type', e.target.value); };
    let delBtn = document.createElement('button'); delBtn.type = 'button'; delBtn.textContent = '–';
    delBtn.onclick = () => removeWindow(idx);
    row.appendChild(document.createTextNode('Wall:')); row.appendChild(wallSel);
    row.appendChild(document.createTextNode(' W:')); row.appendChild(widthInput);
    row.appendChild(document.createTextNode('m H:')); row.appendChild(heightInput);
    row.appendChild(document.createTextNode('m Type:')); row.appendChild(typeSel);
    if (windowsData.length > 1) row.appendChild(delBtn);
    list.appendChild(row);
  });
}
function getAverageWindowUValue() {
  if (!windowsData.length) return 2.8;
  let sumArea = 0, sumUxA = 0;
  windowsData.forEach(w => {
    let t = WINDOW_TYPES.find(t=>t.value===w.type) || WINDOW_TYPES[0];
    let area = (w.width * w.height) || 0; sumUxA += t.u * area; sumArea += area;
  });
  return sumArea ? (sumUxA / sumArea) : 2.8;
}
function showSolarPVInput() {
  var val = document.getElementById('renewables').value;
  document.getElementById('solar-pv-group').style.display = (val === 'Solar PV') ? '' : 'none';
}
function estimateSAP(floorU, wallU, roofU, renew, heating, solarKwh) {
  let base = 60;
  base += (0.25 - floorU) * 40;
  base += (0.25 - wallU) * 40;
  base += (0.25 - roofU) * 40;
  if (/solar pv/i.test(renew)) base += 7 + Math.min(solarKwh/500, 5);
  if (/solar thermal/i.test(renew)) base += 4;
  if (/heat pump/i.test(heating.toLowerCase())) base += 5;
  if (/electric/i.test(heating.toLowerCase())) base -= 5;
  if (base > 100) base = 100;
  if (base < 30) base = 30;
  return Math.round(base);
}
function epcRating(sap) {
  if (sap >= 92) return 'A';
  if (sap >= 81) return 'B';
  if (sap >= 69) return 'C';
  if (sap >= 55) return 'D';
  if (sap >= 39) return 'E';
  if (sap >= 21) return 'F';
  return 'G';
}
function generateReport() {
  const ceilingHeight = parseFloat(document.getElementById('ceiling-height').value) || 2.4;
  const floorIdx = document.getElementById('floor-type').value;
  const wallIdx = document.getElementById('wall-type').value;
  const roofIdx = document.getElementById('roof-type').value;
  const floorU = parseFloat(document.getElementById('floor-uval').value);
  const wallU = parseFloat(document.getElementById('wall-uval').value);
  const roofU = parseFloat(document.getElementById('roof-uval').value);
  const floorArea = parseFloat(document.getElementById('floor-area').value) || 0;
  const wallArea = parseFloat(document.getElementById('wall-area').value) || 0;
  const roofArea = parseFloat(document.getElementById('roof-area').value) || 0;
  const door = document.getElementById('doors').value;
  const doorOrient = document.getElementById('door-orient').value;
  const ren = document.getElementById('renewables').value;
  const heat = document.getElementById('heating').value;
  const heatingKW = parseFloat(document.getElementById('heating-kw').value) || 0;
  let solarPVSize = 0, solarPVKwh = 0;
  if (ren === "Solar PV") {
    solarPVSize = parseFloat(document.getElementById('solar-pv-size').value) || 0;
    solarPVKwh = parseFloat(document.getElementById('solar-pv-kwh').value) || 0;
  }
  let winList = '', totalWinArea = 0;
  winList = windowsData.length ? windowsData.map((w,i)=>{
    let area = (w.width * w.height) || 0;
    totalWinArea += area;
    let winType = WINDOW_TYPES.find(t=>t.value===w.type);
    let uVal = winType ? winType.u : 2.8;
    return `Window ${i+1}: Wall - ${w.wall}, Size - ${w.width}m x ${w.height}m (${area.toFixed(2)} m²), Type - ${w.type} (U=${uVal} W/m²K)`;
  }).join("<br>") : "None";
  const avgWinU = getAverageWindowUValue();
  const p = projects[currentProject];
  let storeyText = p.storeys && p.storeys > 1 ? ` (${p.storeys} Storeys)` : (p.storeys == 1 ? ' (1 Storey)' : '');
  let fullAddress = [p.address1, p.address2, p.address3].filter(Boolean).join(', ');
  const totalStoreys = parseInt(p.storeys || 1, 10);
  let sap = estimateSAP(floorU, wallU, roofU, ren, heat, solarPVKwh);
  let winPenalty = Math.round((2.8 - avgWinU) * 5);
  sap += winPenalty;
  if (totalStoreys >= 3) sap -= 2;
  if (sap > 100) sap = 100;
  if (sap < 30) sap = 30;
  const epc = epcRating(sap);
  const volume = (floorArea * ceilingHeight * totalStoreys) || 0;
  const TER = 22, TFEE = 45, DER = TER - 2 + Math.round(Math.random() * 3), DFEE = TFEE - 2 + Math.round(Math.random() * 3);
  const derPass = DER <= TER, dfeePass = DFEE <= TFEE;
  document.getElementById('report-summary').innerHTML = `
    <b>Project:</b> ${p.name}<br>
    <b>Address:</b> ${fullAddress}<br>
    <b>Post Code:</b> ${p.postcode}<br>
    <b>Project Type:</b> ${p.type}${storeyText}<br>
    <b>Ceiling Height:</b> ${ceilingHeight} m<br>
    <b>Number of Storeys:</b> ${totalStoreys}<br>
    <b>Estimated Total Volume:</b> ${volume.toFixed(2)} m³<br>
    <hr>
    <b>Fabric Details:</b><br>
    Floor: ${UVALS.floor[floorIdx].name}<br>
    &nbsp;&nbsp;Insulation: <b>${UVALS.floor[floorIdx].insulation}</b>, U-Value: <b>${floorU.toFixed(2)} W/m²K</b>, Area: <b>${floorArea} m²</b><br>
    Wall: ${UVALS.wall[wallIdx].name}<br>
    &nbsp;&nbsp;Insulation: <b>${UVALS.wall[wallIdx].insulation}</b>, U-Value: <b>${wallU.toFixed(2)} W/m²K</b>, Area: <b>${wallArea} m²</b><br>
    Roof: ${UVALS.roof[roofIdx].name}<br>
    &nbsp;&nbsp;Insulation: <b>${UVALS.roof[roofIdx].insulation}</b>, U-Value: <b>${roofU.toFixed(2)} W/m²K</b>, Area: <b>${roofArea} m²</b><br>
    <hr>
    <b>Front Door:</b> ${door} (${doorOrient})<br>
    <b>Windows:</b><br>
    ${winList}<br>
    <b>Average Window U-Value:</b> ${avgWinU.toFixed(2)} W/m²K<br>
    <b>Total Window Area:</b> ${totalWinArea.toFixed(2)} m²
    <hr>
    <b>Renewables:</b> ${ren}<br>
    ${ren === "Solar PV" ? `<b>Solar PV System:</b> ${solarPVSize} kWp<br><b>Estimated Output:</b> ${solarPVKwh} kWh/year` : ""}
    <b>Heating:</b> ${heat}<br>
    <b>Heating System Output:</b> ${heatingKW ? heatingKW + " kW" : "n/a"}<br>
    <hr>
    <b>Estimated SAP Score:</b> <span style="font-size:1.15em;font-weight:bold;">${sap}</span><br>
    <b>Estimated EPC Rating:</b> <span style="font-size:1.15em;font-weight:bold;color:green;">${epc}</span><br>
    <b>Target Emission Rate (TER):</b> <span style="font-weight:bold;">${TER} kgCO₂/m²/year</span><br>
    <b>Dwelling Emission Rate (DER):</b> <span style="font-weight:bold; color:${derPass ? 'green' : 'red'}">${DER} kgCO₂/m²/year ${derPass ? 'PASS' : 'FAIL'}</span><br>
    <b>Target Fabric Energy Efficiency (TFEE):</b> <span style="font-weight:bold;">${TFEE} kWh/m²/year</span><br>
    <b>Dwelling Fabric Energy Efficiency (DFEE):</b> <span style="font-weight:bold; color:${dfeePass ? 'green' : 'red'}">${DFEE} kWh/m²/year ${dfeePass ? 'PASS' : 'FAIL'}</span>
    <br>
    <br>
    <b>SAP Report:</b> <span style="color:${derPass && dfeePass ? 'green' : 'red'}">${derPass && dfeePass ? 'PASS' : 'FAIL'} (Preview Only)</span><br>
    <b>U-Value Report:</b> <span style="color:green">Compliant (Preview Only)</span>
  `;
  document.getElementById('materials-list-output').style.display = 'none';
  document.getElementById('materials-list-output').innerHTML = "";
  showScreen('reports-screen');
}

/* --- upload logic for four plan/spec files --- */
function handleFileUpload(inputId, listId, key) {
  document.getElementById(inputId).addEventListener('change', function(e) {
    const file = e.target.files[0];
    uploadedPlans[key] = file ? file.name : null;
    document.getElementById(listId).innerHTML = file ? `<div class='uploaded-file'><b>Uploaded:</b> ${file.name}</div>` : "";
    updatePlansMessage();
  });
}
function updatePlansMessage() {
  let files = [];
  if (uploadedPlans.civils) files.push("Civils");
  if (uploadedPlans.ground) files.push("Ground Floor");
  if (uploadedPlans.first) files.push("First Floor");
  if (uploadedPlans.spec) files.push("Spec");
  document.getElementById('plans-message').textContent =
    files.length ? `Uploaded: ${files.join(', ')}. Fields will be auto-filled after project creation.` : '';
  document.getElementById('plans-note').style.display = files.length ? '' : 'none';
}
handleFileUpload('plans-upload-civils', 'uploaded-files-list-civils', 'civils');
handleFileUpload('plans-upload-ground', 'uploaded-files-list-ground', 'ground');
handleFileUpload('plans-upload-first', 'uploaded-files-list-first', 'first');
handleFileUpload('plans-upload-spec', 'uploaded-files-list-spec', 'spec');

/* --- Materials list generator --- */
function generateMaterialsList(inNewWindow) {
  const floorArea = parseFloat(document.getElementById('floor-area').value) || 0;
  const wallArea = parseFloat(document.getElementById('wall-area').value) || 0;
  const roofArea = parseFloat(document.getElementById('roof-area').value) || 0;
  const ceilingHeight = parseFloat(document.getElementById('ceiling-height').value) || 2.4;
  const heatingKW = parseFloat(document.getElementById('heating-kw').value) || 0;
  const numRooms = parseInt(document.getElementById('num-rooms').value) || 1;
  const totalStoreys = parseInt(projects[currentProject]?.storeys || 1, 10);

  let materials = [
    { name: "Floor Insulation", qty: floorArea },
    { name: "Concrete/floor slab (ground floor)", qty: floorArea },
    { name: "Damp proof membrane", qty: floorArea },
    { name: "Sand (floor slab)", qty: floorArea },
    { name: "Cement (floor slab)", qty: floorArea },
    { name: "Wall Insulation", qty: wallArea },
    { name: "Bricks (outer leaf)", qty: wallArea },
    { name: "Concrete blocks (inner leaf)", qty: wallArea },
    { name: "Wall ties", qty: wallArea / 2 },
    { name: "Cavity closers", qty: 10 },
    { name: "Sand (mortar)", qty: wallArea },
    { name: "Cement (mortar)", qty: wallArea },
    { name: "Roof Insulation", qty: roofArea },
    { name: "Roof covering (tiles/membrane)", qty: roofArea },
    { name: "Gutters", qty: Math.ceil(roofArea / 10) },
    { name: "Fascia boards", qty: Math.ceil(roofArea / 10) },
    { name: "Soffit boards", qty: Math.ceil(roofArea / 10) },
    { name: "Plasterboard/internal wall finish", qty: wallArea + (ceilingHeight * wallArea / 2) },
    { name: "Ceiling board", qty: roofArea },
    { name: "Plaster (skim)", qty: wallArea + roofArea },
    { name: "Skirting & architrave", qty: wallArea / 8 },
    { name: "Wall paint", qty: wallArea / 3 },
    { name: "Ceiling paint", qty: roofArea / 2 }
  ];
  for (let floor = 1; floor <= totalStoreys; floor++) {
    materials.push(
      { name: `Stairs (floor ${floor})`, qty: (floor > 1 ? 1 : 0) },
      { name: `1st fix plumbing (floor ${floor})`, qty: 1 },
      { name: `2nd fix plumbing (floor ${floor})`, qty: 1 },
      { name: `1st fix electrics (floor ${floor})`, qty: 1 },
      { name: `2nd fix electrics (floor ${floor})`, qty: 1 },
      { name: `Joinery (floor ${floor})`, qty: 1 },
      { name: `Ironmongery (floor ${floor})`, qty: 1 }
    );
  }
  const roomsPerFloor = Math.ceil(numRooms / totalStoreys);
  for (let floor = 1; floor <= totalStoreys; floor++) {
    materials.push(
      { name: `Radiator (floor ${floor})`, qty: roomsPerFloor },
      { name: `Socket (floor ${floor})`, qty: roomsPerFloor * 4 },
      { name: `LED downlight (floor ${floor})`, qty: roomsPerFloor * 4 }
    );
  }
  materials.push({ name: "EV charger", qty: 1 });
  if (heatingKW > 0) {
    materials.push({ name: "Heating system (boiler/heat pump)", qty: heatingKW });
  }
  function getMaterialPriceWithHeating(item, qty) {
    if (item.startsWith("Heating system")) return 100 * qty;
    if (item.startsWith("Stairs")) return MATERIAL_PRICES["Stairs"] * qty;
    if (item.startsWith("1st fix plumbing")) return MATERIAL_PRICES["1st fix plumbing"] * qty;
    if (item.startsWith("2nd fix plumbing")) return MATERIAL_PRICES["2nd fix plumbing"] * qty;
    if (item.startsWith("Radiator")) return MATERIAL_PRICES["Radiator"] * qty;
    if (item.startsWith("1st fix electrics")) return MATERIAL_PRICES["1st fix electrics"] * qty;
    if (item.startsWith("2nd fix electrics")) return MATERIAL_PRICES["2nd fix electrics"] * qty;
    if (item.startsWith("Socket")) return MATERIAL_PRICES["Socket"] * qty;
    if (item.startsWith("LED downlight")) return MATERIAL_PRICES["LED downlight"] * qty;
    if (item.startsWith("EV charger")) return MATERIAL_PRICES["EV charger"] * qty;
    if (item.startsWith("Joinery")) return MATERIAL_PRICES["Joinery"] * qty;
    if (item.startsWith("Ironmongery")) return MATERIAL_PRICES["Ironmongery"] * qty;
    return getMaterialPrice(item, qty);
  }
  let html = `<h2 style="color:#003366;">Materials, Labour & Profit Breakdown</h2>
  <h3>Materials (est.)</h3><ul>`;
  let totalMaterials = 0;
  materials.forEach(mat => {
    if (!mat.qty) return;
    let cost = getMaterialPriceWithHeating(mat.name, mat.qty);
    totalMaterials += cost;
    html += `<li>${mat.name}: ${mat.qty.toFixed(1)} &ndash; £${cost.toFixed(2)}</li>`;
  });
  windowsData.forEach((w, i) => {
    let cost = getMaterialPrice("Window "+(i+1), 1);
    totalMaterials += cost;
    html += `<li>Window ${i+1} (${w.type}): 1 &ndash; £${cost.toFixed(2)}</li>`;
  });
  html += `</ul><b>Total Materials: £${totalMaterials.toFixed(2)}</b>`;
  html += `<h3>Materials Table</h3><table class="materials-table">
    <tr><th>Material</th><th>Unit Price</th><th>Qty</th><th>Cost</th></tr>`;
  let runningMaterialsTotal = 0;
  materials.forEach(mat => {
    if (!mat.qty) return;
    let unit = getMaterialPriceWithHeating(mat.name, 1);
    let qty = mat.qty;
    let cost = getMaterialPriceWithHeating(mat.name, qty);
    runningMaterialsTotal += cost;
    html += `<tr><td>${mat.name}</td><td>£${unit.toFixed(2)}</td><td>${qty.toFixed(1)}</td><td>£${cost.toFixed(2)}</td></tr>`;
  });
  windowsData.forEach((w, i) => {
    let unit = getMaterialPrice("Window "+(i+1), 1);
    let cost = unit;
    runningMaterialsTotal += cost;
    html += `<tr><td>Window ${i+1} (${w.type})</td><td>£${unit.toFixed(2)}</td><td>1</td><td>£${cost.toFixed(2)}</td></tr>`;
  });
  html += `<tr class="materials-total-row"><td colspan="3">Total Materials</td><td>£${runningMaterialsTotal.toFixed(2)}</td></tr></table>`;

  let elecLabourRate = 35; // £/hr
  let elecHoursPerFloor = 40;
  let plumbingLabourRate = 32; // £/hr
  let plumbingHoursPerFloor = 35;
  let totalLabour = 0;
  html += `<h3>Labour (est.)</h3><table class="labour-table">
    <tr><th>Task</th><th>Rate</th><th>Qty</th><th>Cost</th></tr>`;
  let labour = [
    { task: "Groundworks", rate: 18, qty: floorArea / 10 },
    { task: "Bricklaying", rate: 20, qty: wallArea / 8 },
    { task: "Carpentry (roof)", rate: 22, qty: roofArea / 12 },
    { task: "Window Fitting", rate: 60, qty: windowsData.length },
    { task: "General Labour", rate: 17, qty: (floorArea + wallArea + roofArea) / 40 }
  ];
  for (let floor = 1; floor <= totalStoreys; floor++) {
    labour.push(
      { task: `Electrical 1st & 2nd fix (floor ${floor})`, rate: elecLabourRate, qty: elecHoursPerFloor },
      { task: `Plumbing 1st & 2nd fix (floor ${floor})`, rate: plumbingLabourRate, qty: plumbingHoursPerFloor }
    );
  }
  labour.forEach(l => {
    let cost = l.rate * l.qty;
    totalLabour += cost;
    html += `<tr><td>${l.task}</td><td>£${l.rate}/hr</td><td>${l.qty.toFixed(1)}</td><td>£${cost.toFixed(2)}</td></tr>`;
  });
  html += `<tr class="labour-total-row"><td colspan="3">Total Labour</td><td>£${totalLabour.toFixed(2)}</td></tr></table>`;

  let profit = (totalLabour + totalMaterials) * 0.15;
  html += `<h3>Estimated Profit</h3>
    <table class="total-table">
      <tr><td>Profit (15%)</td><td>£${profit.toFixed(2)}</td></tr>
      <tr class="profit-row"><td><b>Grand Total:</b></td><td><b>£${(totalLabour+totalMaterials+profit).toFixed(2)}</b></td></tr>
    </table>
    <div style="margin-top:12px;color:#005599;font-size:0.96em;">
      <b>Note:</b> All electrical works must comply with IET Wiring Regulations (BS 7671).
    </div>`;

  if (inNewWindow) {
    let win = window.open('', '_blank');
    win.document.write('<html><head><title>Materials, Labour & Profit Breakdown</title>');
    win.document.write('<style>body{font-family:Segoe UI,Arial,sans-serif;background:#f7f9fa;margin:0;padding:20px;}ul{margin:0 0 20px 20px;}h2,h3{color:#003366;}table{border-collapse:collapse;width:100%;margin-top:10px;}th,td{border-bottom:1px solid #e6e6e6;padding:5px 8px;text-align:left;}th{background:#f5fafc;}tr.labour-total-row td,tr.materials-total-row td,tr.profit-row td{font-weight:bold;}tr.profit-row td{color:#007a33;}</style>');
    win.document.write('</head><body>' + html + '</body></html>');
    win.document.close();
  } else {
    document.getElementById('materials-list-output').innerHTML = html;
    document.getElementById('materials-list-output').style.display = '';
  }
}

function emailMaterialsQuote() {
  let html = document.getElementById('materials-list-output').innerHTML;
  let div = document.createElement("div");
  div.innerHTML = html;
  let items = Array.from(div.getElementsByTagName("li")).map(li => li.innerText).join('\n');
  alert("This would send the following materials list to your supplier:\n\n" + items + "\n\n(Demo only - integrate with EmailJS or backend for real emails.)");
}

// Architectural Plans Builder Logic
document.getElementById('architect-builder-btn').onclick = function() {
  showScreen('architect-builder-screen');
};

const ROOM_MIN_SIZES = {
  "Kitchen": 11, "Living Room": 15, "Hallway": 6, "Bathroom": 4.5, "Utility": 4, "Dining Room": 10, "Office": 7,
  "Bedroom": 9, "Ensuite": 3, "Landing": 5, "Storage": 3
};

function calcWindowSize(roomArea) {
  return Math.max(1.5, Math.round(roomArea / 20 * 10) / 10);
}

function calcDoorSize(type) {
  return type === "Front Door" ? 2 : 1.6;
}

document.getElementById('architect-plans-form').onsubmit = function(e) {
  e.preventDefault();

  const w = parseFloat(document.getElementById('house-width').value);
  const l = parseFloat(document.getElementById('house-length').value);
  const h = parseFloat(document.getElementById('house-height').value);

  const downRooms = Array.from(document.getElementById('downstairs-rooms').selectedOptions).map(o=>o.value);
  const upRooms = Array.from(document.getElementById('upstairs-rooms').selectedOptions).map(o=>o.value);

  const houseArea = w * l;
  const allRooms = downRooms.concat(upRooms);
  let totalMinRoomArea = allRooms.reduce((sum, r) => sum + (ROOM_MIN_SIZES[r]||8), 0);
  let scaleFactor = houseArea / totalMinRoomArea;

  let roomDetails = [];
  allRooms.forEach((room, i) => {
    let minSize = ROOM_MIN_SIZES[room] || 8;
    let size = Math.round(minSize * scaleFactor * 10) / 10;
    roomDetails.push({
      name: room,
      area: size,
      window: calcWindowSize(size),
      door: calcDoorSize(room === "Hallway" || room === "Landing" ? "Internal" : "Front Door"),
      floor: i < downRooms.length ? 0 : 1,
      idx: i
    });
  });

  let wallArea = 2 * (w + l) * h;
  let floorArea = houseArea;
  let roofArea = houseArea;
  let ceilingArea = houseArea;
  let windowArea = roomDetails.reduce((sum, r) => sum + r.window, 0);
  let doorArea = roomDetails.reduce((sum, r) => sum + r.door, 0);

  let materials = [
    { name: "Floor Insulation", qty: floorArea },
    { name: "Concrete/floor slab (ground floor)", qty: floorArea },
    { name: "Wall Insulation", qty: wallArea },
    { name: "Bricks (outer leaf)", qty: wallArea },
    { name: "Concrete blocks (inner leaf)", qty: wallArea },
    { name: "Roof Insulation", qty: roofArea },
    { name: "Roof tiles", qty: roofArea },
    { name: "Plasterboard/internal wall finish", qty: wallArea + ceilingArea },
    { name: "Ceiling board", qty: ceilingArea },
    { name: "Wall paint", qty: wallArea },
    { name: "Ceiling paint", qty: ceilingArea },
    { name: "Windows", qty: windowArea },
    { name: "Doors", qty: doorArea }
  ];

  let output = `<h3>Materials List</h3><ul>`;
  materials.forEach(m=>{
    output += `<li>${m.name}: <b>${Math.round(m.qty*10)/10} m²</b></li>`;
  });
  output += `</ul>`;

  output += `<h3>Room Breakdown</h3><ul>`;
  roomDetails.forEach(r=>{
    output += `<li>${r.name} (${r.area} m², Window: ${r.window} m², Door: ${r.door} m², ${r.floor===0?'Downstairs':'Upstairs'})</li>`;
  });
  output += `</ul>`;

  document.getElementById('architect-plans-output').innerHTML = output;

  let svgW = 400, svgH = 250, margin = 20;
  let roomW = Math.max(1, Math.floor((svgW-margin*2)/Math.ceil(Math.sqrt(roomDetails.length))));
  let roomH = Math.max(1, Math.floor((svgH-margin*2)/Math.ceil(Math.sqrt(roomDetails.length))));
  let svg = `<svg width="${svgW}" height="${svgH}" style="background:#f7f9fa;border:1px solid #bbb;border-radius:8px">`;

  let cols = Math.ceil(Math.sqrt(roomDetails.length));
  let rows = Math.ceil(roomDetails.length / cols);
  let idx = 0;
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      if (idx >= roomDetails.length) continue;
      let room = roomDetails[idx];
      let x = margin + c*roomW;
      let y = margin + r*roomH;
      svg += `<rect x="${x}" y="${y}" width="${roomW-8}" height="${roomH-8}" fill="#e7f0fa" stroke="#005599" stroke-width="2"/>`;
      svg += `<text x="${x+8}" y="${y+20}" font-size="14" fill="#003366">${room.name}</text>`;
      svg += `<rect x="${x+roomW-24}" y="${y+6}" width="16" height="8" fill="#6fc1ff" stroke="#005599" stroke-width="1"/>`;
      svg += `<rect x="${x+((roomW-8)/2)-8}" y="${y+roomH-14}" width="16" height="8" fill="#c0976b" stroke="#8b5a2b" stroke-width="1"/>`;
      idx++;
    }
  }
  svg += `</svg>`;
  document.getElementById('architect-2d-plan').innerHTML = `<h3>2D Floor Plan (Preview)</h3>` + svg;
};
</script>
</body>
</html>
